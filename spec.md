# AEC3 エコーキャンセル仕様書
## 1. 概要

echoback.cc では WebRTC 派生の Acoustic Echo Canceller 3 (以下 AEC3) を用いて、
遠端から再生されるレンダー信号と近端マイクで収音されたキャプチャ信号間のエコー成分を除去する。
本仕様書では、実装 (`echo_canceller3.h` ほか) に準じたアルゴリズムの処理段階を数式と共に記述する。

## 2. 信号モデルと記号

- $x[n]$: 遠端からのレンダー信号 (スピーカー入力)。
- $y[n]$: 近端マイクで観測されたキャプチャ信号。
- $d[n]$: 近端発話 (ダブルトーク) 成分。
- $v[n]$: マイクノイズ。
- 実際の観測は $y[n] = (h * x)[n] + d[n] + v[n]$ で表される。ここで $h[n]$ はエコーパスのインパルス応答。
- ブロック長 $M = 64$ サンプル、FFT 長 $L = 2M = 128$。各ブロックはベクトル $\mathbf{x}_b = [x[bM], \ldots, x[bM + M - 1]]^T$ で表す。
- パーティション数 $P = 13$。適応 FIR フィルタは $PM$ サンプル相当のインパルス応答を表現する。

## 3. 全体処理フロー

AEC3 は 64 サンプル単位のブロック処理で動作し、図示すると以下の段階を踏む。

1. レンダー信号バッファリング
2. 遅延推定
3. 線形エコー推定 (Subtractor)
4. 状態評価および残留エコー推定
5. 非線形抑圧ゲイン算出
6. 時間領域復元と出力

各段階を順に説明する。

## 4. レンダー信号バッファリング

`EchoCanceller3::AnalyzeRender` で取得した $\mathbf{x}_b$ は
`RenderDelayBuffer` に時系列順でエンキューされる。
同時に、FFT ドメイン表現 $\mathbf{X}_b$ を保持する多段バッファ (リングバッファ) が `RenderBuffer` に更新される。

- 各ブロックはハン窓 $w[m]$ を掛けた後、ゼロパディングして $L$ 点 FFT を計算し、複素スペクトル $X_b[k]$ を得る。
- `RenderBuffer` は $P$ 個の最新 FFT ブロックを循環参照できるように並び替え、後段のパーティション畳み込みで使用する。


## 5. 遅延推定

`EchoPathDelayEstimator` はレンダー信号を 4 kHz 帯域へダウンサンプリングし、マッチドフィルタと統計的検定でエコーパス遅延を推定する。

1. ダウンサンプリング:
   $$x_d[m] = \sum_{i=0}^{N_d-1} h_d[i] \cdot x[mR + i]$$
2. 遅延候補の相互相関:
   $$r_{xy}[\ell] = \sum_m x_d[m] \cdot y_d[m+\ell]$$
3. 遅延推定値:
   $$\hat{\tau} = \arg\max_{\ell} \; r_{xy}[\ell]$$
   ただし信頼度がしきい値を下回る場合は `-1` (未知) とする。
4. 推定遅延が有効なとき、`RenderDelayBuffer::AlignFromDelay` がレンダーバッファの読み出し位置を $\hat{\tau}$ ブロックだけ先行・遅延させ、線形フィルタの入力を整列させる。 遅延変化やバッファアンダーランが検出された場合は `EchoPathVariability` がフラグを立て、後段の線形フィルタと状態をリセットする。

## 6. 線形エコー推定 (Subtractor)

`Subtractor` はパーティション化周波数領域適応フィルタ (PFDAF) を用いてエコー成分を推定する。

### 6.1 フィルタ出力形成

各パーティション $p \in \{0,\ldots,P-1\}$ について、対応するレンダー FFT ブロック $X_{b-p}[k]$ とフィルタ係数 $H_p[k]$ を用い、推定エコーの周波数応答を求める。

$$S_b[k] = \sum_{p=0}^{P-1} H_p[k] X_{b-p}[k]$$

時間領域の推定エコーブロック $\hat{s}_b[m]$ は逆 FFT で得る。

### 6.2 残差信号

観測ブロック $\mathbf{y}_b$ から推定エコーを減算し、残差信号 $\mathbf{e}_b$ を計算する。

$$\mathbf{e}_b = \mathbf{y}_b - \hat{\mathbf{s}}_b$$

FFT を適用して残差信号スペクトル $E_b[k]$ とパワースペクトル $|E_b[k]|^2$ を得る。

### 6.3 フィルタ係数更新

`FilterUpdateGain` は正規化 NLMS 系の更新ゲインを周波数ごとに算出する。

1. 入力エネルギー推定:
   $$\Phi_{xx}[k] = \sum_{p=0}^{P-1} |X_{b-p}[k]|^2$$
2. 更新ゲイン計算 (簡略化表記):
   $$G[k] = \mu(k) \frac{X_b^*[k] E_b[k]}{\epsilon + \Phi_{xx}[k]}$$
   ここで $\mu(k)$ は ERL・信頼度に依存するステップサイズ、$\epsilon$ は発散防止の微小量。
3. 係数更新:
   $$H_p[k] \leftarrow H_p[k] + X_{b-p}[k] G[k]$$
   `AdaptiveFirFilter::Adapt` では `RenderBuffer` 上のパーティションを巡回しながら上式を適用する。
4. 時間領域制約: 逆 FFT → 窓掛け → 再 FFT を周期的に行い、フィルタ係数のリーク対策・安定化を図る (`Constrain`)。

### 6.4 エコーパス変化への対応

`EchoPathVariability` が遅延変化を示した場合、`HandleEchoPathChange` により全パーティション係数 $H_p$ をゼロクリアして再収束を促す。

## 7. 状態評価と残留エコー推定

`AecState` は線形推定の有効性や ERLE (Echo Return Loss Enhancement) を追跡する。

- ERLE 指標:
  $$\text{ERLE}_b[k] = 10 \log_{10} \frac{\mathbb{E}[|y_b[k]|^2]}{\mathbb{E}[|e_b[k]|^2]}$$
  周波数平均値が所定しきい値を超える場合、線形推定が「利用可能」とみなされる。
- 残留エコー推定 (`ResidualEchoEstimator`):
  $$R_b[k] = \alpha R_{b-1}[k] + (1-\alpha) \hat{S}_b^2[k] + \beta \Phi_{xx}[k]$$
  ここで $\hat{S}_b^2[k]$ は線形推定エコーのパワー、$\alpha$ は時間平滑係数、$\beta$ はダブルトーク時の安全マージン。
- 状態はレンダー入力のばらつき、ダブルトーク検知、推定遅延の安定度などを統合して非線形抑圧の挙動を制御する。

## 8. 非線形抑圧ゲイン計算

線形推定が有効かどうかで抑圧モードが分岐する。

1. スペクトル算出:
   - キャプチャスペクトル: $Y_b[k]$、パワー $Y_2[k] = |Y_b[k]|^2$
   - 残差信号スペクトル: $E_b[k]$、パワー $E_2[k] = |E_b[k]|^2$
2. 参照スペクトル選択:
   $$\hat{Y}_b[k] = \begin{cases}E_b[k] & \text{線形推定が有効}\\ Y_b[k] & \text{それ以外}\end{cases}$$
   $$\hat{S}_2[k] = \begin{cases}S_2[k] & \text{線形推定有効}\\ R_b[k] & \text{それ以外}\end{cases}$$
3. 抑圧ゲイン (`SuppressionGain`):
   $$G_b[k] = \max\left(G_{\min},\; f\big(E_2[k], \hat{S}_2[k], R_b[k]\big)\right)$$
   ここで $f(\cdot)$ は近端・残留エコー比に基づく非線形写像 (例: ログスペクトル減算法)。$G_{\min}$ は過剰抑圧防止の下限ゲイン。
4. 安定化処理: 周波数平滑・時間平滑を行い、高域でのホワイトニング抑圧やフロアリングを実施する。

## 9. 時間領域復元

抑圧ゲインを適用したスペクトル $\tilde{Y}_b[k] = G_b[k] \cdot \hat{Y}_b[k]$ を逆 FFT し、オーバーラップ・アド方式で時間領域ブロック $\tilde{y}_b[m]$ を得る。

$$\tilde{y}_b[m] = \text{IFFT}\left\{\tilde{Y}_b[k]\right\}[m + M]$$

最後に、64 サンプルの有効部分を取り出して `AudioBuffer` へ書き戻す。

## 10. モード切替

`EchoCanceller3::SetProcessingModes` により以下の組み合わせを選択できる。

- 線形 + 非線形 (既定): 全段を実行。
- 線形のみ: `Subtractor` の出力 $\mathbf{e}_b$ をそのまま時間領域へ戻し、抑圧処理をスキップ。
- 非線形のみ: 入力 $\mathbf{y}_b$ を直接非線形抑圧に供給し、線形フィルタを停止。
モード変更時も残留状態は継続するが、無効化されたモジュールは更新を停止する。
## 11. エラーハンドリングとリセット条件
- レンダーバッファのオーバーラン検出時: 過去ブロックとの整合性が失われるため、遅延推定とフィルタ状態をリセット。
- 遅延推定失敗 ($\hat{\tau} < 0$): 既存アライメントを維持し、線形フィルタは直前の設定で処理を継続。
- エコーパス変化フラグ: フィルタ係数と統計量を初期化し、再収束を図る。
- ダブルトーク強度が高い場合: 非線形抑圧のゲインを保守的に設定し、近端音声の劣化を抑える。

## 12. 実装参照

- `echo_canceller3.h`: API エントリーポイント。
- `block_processor.h`: レンダーバッファリング、遅延推定、`EchoRemover` 呼び出し。
- `echo_remover.h`: 線形減算と非線形抑圧の統合。
- `subtractor.h` / `adaptive_fir_filter.h`: PFDAF のコア実装。
- `residual_echo_estimator.h`, `suppression_gain.h`, `suppression_filter.h`: 残留推定とゲイン適用。
